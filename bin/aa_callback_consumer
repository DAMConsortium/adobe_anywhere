#!/usr/bin/env ruby
require 'optparse'
require 'pp'

if %w(start stop restart reload run zap status).include?((command = ARGV.first) ? command.downcase : command)
  require 'daemons'
  Daemons.run($0)
  exit
end

begin
  require 'adobe_anywhere/callback_monitor'
rescue LoadError
  lib_path = File.expand_path('../../lib', __FILE__)
  unless $:.include?(lib_path)
    $:.unshift(lib_path)
    #warn("Retrying to load AdobeAnywhere after adding #{lib_path} to $LOAD_PATH. The GEM may not be installed correctly.")
    retry
  end
  abort("Failed to load the AdobeAnywhere gem. #{$!}")
end

app = AdobeAnywhere::CallbackMonitor

options = { }
options[:mig_executable_path] = '/Library/Scripts/ubiquity/media_processing_tool/bin/mig'
options[:binding] = '0.0.0.0'
options[:log_level] = Logger::DEBUG
options[:log_to] = STDOUT

op = OptionParser.new

op.on('--config-file FILEPATH', 'Required. The path to the configuration file.') { |v| options[:config_file_path] = v }
op.on('--adobe-anywhere-host-address HOSTADDRESS', '') { |v| options[:host_address] = v }
op.on('--adobe-anywhere-port PORT', '') { |v| options[:port] = v }
op.on('--adobe-anywhere-username USERNAME', '') { |v| options[:username] = v }
op.on('--adobe-anywhere-password PASSWORD', '') { |v| options[:password] = v }
op.on('--[no-]mig-path [FILEPATH]', '') { |v| options[:mig_executable_path] = v }
op.on('--binding BINDING', '') { |v| options[:binding] = v }
op.on('--log-to FILEPATH', '') { |v| options[:log_to] = v }
op.on('--log-level LOGLEVEL', '') { |v| options[:log_level] = v }
op.on('--[no-]options-file [FILEPATH]' ) { |v| options[:options_file_name] = v }
op.on_tail('-h', '--help', 'Show this message.') { puts op; exit }

# Parse the command line so that we can see if we have an options file
op.parse!(ARGV.dup)

options_file_name = options[:options_file_name]

# Make sure that options from the command line override those from the options file
op.parse!(ARGV.dup) if op.load(options_file_name)

logger = Logger.new(options[:log_to] || STDOUT)
logger.level = options[:log_level]

options[:logger] = logger

config_file_path = options[:config_file_path]
abort('A configuration file path must be specified.') unless config_file_path
abort("File Not Found. #{config_file_path}") unless File.exist?(config_file_path)


aa = AdobeAnywhere::API::Utilities.new(options)
aa.parse_response = true
aa.http.log_request_body = true
aa.http.log_response_body = true
aa.http.log_pretty_print_body = true

abort('Login to the AdobeAnywhere server failed.') unless aa.login

app.set(:logger, logger)
#existing_methods = app.methods
app.set(:aa, aa)
app.set(:bind, options.delete(:binding))
app.set(:mig_executable_path, options.delete(:mig_executable_path))
app.set(:initial_options, options)

#logger.debug { "Settings #{(app.methods - existing_methods).keep_if { |v| !v.to_s.end_with?('?', '=')}}" }
app.run!



